FROM tperalta82/ubuntu-nomachine

MAINTAINER BCU "linus.pithan@esrf.fr"

ENV PATH /opt/conda/bin:$PATH

RUN apt-get update --fix-missing && \
    apt-get install -y wget bzip2 dpkg gnome-sushi ca-certificates curl git novnc websockify python-numpy  && \
    DEBIAN_FRONTEND=noninteractive apt install -y x11vnc xvfb net-tools && \
    apt-get clean && \
    apt-get autoclean 

RUN wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-4.5.11-Linux-x86_64.sh -O ~/miniconda.sh && \
    /bin/bash ~/miniconda.sh -b -p /opt/conda && \
    rm ~/miniconda.sh && \
    /opt/conda/bin/conda clean -tipsy && \
    ln -s /opt/conda/etc/profile.d/conda.sh /etc/profile.d/conda.sh && \
    echo ". /opt/conda/etc/profile.d/conda.sh" >> ~/.bashrc && \
    echo "conda activate base" >> ~/.bashrc

RUN wget https://zoom.us/client/latest/zoom_amd64.deb && \
    dpkg -i zoom_amd64.deb || : && \
    apt-get -y -f install && \
    rm zoom_amd64.deb && \
    apt-get clean && \
    apt-get autoclean 

RUN x11vnc -storepasswd nomachine /etc/x11vnc.pass

RUN wget -c https://people.debian.org/~picca/libtango-java_9.2.5a-1_all.deb && \
    echo "tango-common tango-common/tango-host string localhost:10000" | debconf-set-selections && \
    DEBIAN_FRONTEND=noninteractive apt-get -q -y install tango-common openjdk-8-jre && \
    dpkg -i ./libtango-java_9.2.5a-1_all.deb || : && \
    apt-get -y -f install && \
    apt-get clean && \
    apt-get autoclean 

# Add Tini
ENV TINI_VERSION v0.19.0
ADD https://github.com/krallin/tini/releases/download/${TINI_VERSION}/tini /tini
RUN chmod +x /tini

RUN git clone https://github.com/linupi/bliss_webinar && \
    cd bliss_webinar && \
    git reset --hard origin/no_vnc && \
    cd / && \
    find bliss_webinar -name '*.sh' -exec chmod a+x {} +  

RUN git clone https://gitlab.esrf.fr/bliss/bliss

RUN /bliss_webinar/install_script.sh && \
    /bliss_webinar/bliss/install_script.sh

EXPOSE 6080

ENTRYPOINT ["/tini", "--"]
CMD ["/bliss_webinar/bootstrap_script.sh"]

